<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Python 写一个简易的数据库. &mdash; 张建新</title>
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/components/collection.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/globals/common.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://firsh.me/2017/08/07/python-laladb/">
    <link rel="alternate" type="application/atom+xml" title="张建新" href="/feed.xml">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <meta property="og:title" content="Python 写一个简易的数据库.">
      
    <meta name="keywords" content="Python,lambda">
    <meta name="og:keywords" content="Python,lambda">
      
    <meta name="description" content="没事看看文章而已～">
    <meta name="og:description" content="没事看看文章而已～">
      
    
    
        
    
    <meta property="og:url" content="http://firsh.me/2017/08/07/python-laladb/">
    <meta property="og:site_name" content="张建新">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2017-08-07">
    
    <script src="https://zmatsh.b0.upaiyun.com/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="https://zmatsh.b0.upaiyun.com/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="/" title="张建新"><span class="octicon octicon-mark-github"></span> 张建新</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="/" class=" site-header-nav-item" target="" title="Index">Index</a>
                
                <a href="/categories/" class=" site-header-nav-item" target="" title="categories">categories</a>
                
                <a href="/open-source/" class=" site-header-nav-item" target="" title="open-source">open-source</a>
                
                <a href="/wiki/" class=" site-header-nav-item" target="" title="wiki">wiki</a>
                
                <a href="/links/" class=" site-header-nav-item" target="" title="links">links</a>
                
                <a href="/about/" class=" site-header-nav-item" target="" title="about">about</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="Python 写一个简易的数据">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">Python 写一个简易的数据库.</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2017/08/07
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#Python,lambda" title="Python,lambda">Python,lambda</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-3969253077255521",
        enable_page_level_ads: true
    });
</script>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <p>没事看看文章而已～</p>

<h1 id="教你用100多行写一个数据库附源码">教你用100多行写一个数据库（附源码）</h1>

<p>本文介绍的是以为中国的IT资深人士写的一个简单的数据库，没有我们使用的数据库那么强大，但是值得大家借鉴。可以用在特定环境中，更加灵活方便。</p>

<p>数据库的名字叫WawaDB，是用python实现的。由此可见python是灰常强大啊！</p>

<h2 id="简介">简介</h2>

<p>记录日志的需求一般是这样的：</p>

<p>只追加，不修改，写入按时间顺序写入；</p>

<p>大量写，少量读，查询一般查询一个时间段的数据；</p>

<p>MongoDB的固定集合很好的满足了这个需求，但是MongoDB占内存比较大，有点儿火穿蚊子，小题大做的感觉。</p>

<p>WawaDB的思路是每写入1000条日志，在一个索引文件里记录下当前的时间和日志文件的偏移量。</p>

<p>然后按时间询日志时，先把索引加载到内存中，用二分法查出时间点的偏移量，再打开日志文件seek到指定位置，这样就能很快定位用户需要的数据并读取，而不需要遍历整
个日志文件。</p>

<h2 id="性能">性能</h2>

<p>Core 2 P8400,2.26GHZ,2G内存，32 bit win7</p>

<p>写入测试：</p>

<p>模拟1分钟写入10000条数据，共写入5个小时的数据， 插入300万条数据，每条数据54个字符，用时2分51秒</p>

<p>读取测试:读取指定时间段内包含某个子串的日志</p>

<p>数据范围 遍历数据量 结果数 用时（秒）</p>

<p>5小时 300万 604 6.6</p>

<p>2小时 120万 225 2.7</p>

<p>1小时 60万 96 1.3</p>

<p>30分钟 30万 44 0.6</p>

<h2 id="索引">索引</h2>

<p>只对日志记录的时间做索引， 简介里大概说了下索引的实现，二分查找肯定没B Tree效率高，但一般情况下也差不了一个数量级，而且实现特别简单。</p>

<p>因为是稀疏索引，并不是每条日志都有索引记录它的偏移量，所以读取数据时要往前多读一些数据，防止漏读，等读到真正所需的数据时再真正给用户返回数据。</p>

<p>如下图，比如用户要读取25到43的日志，用二分法找25，找到的是30所在的点，</p>

<p>索引：0         10        20        30        40        50
日志：|………|………|………|………|………|»&gt;a = [0, 10, 20, 30,
40, 50]»&gt;bisect.bisect_left(a, 35)»&gt;3»&gt;a[3]»&gt;30»&gt;bisect.bisect_left(a,
43)»&gt;5»&gt;a[5]»&gt;50</p>

<p>所以我们要往前倒一些，从20（30的前一个刻度）开始读取日志，21，22，23，24读取后因为比25小，所以扔掉, 读到25,26,27,…后返回给用户</p>

<p>读取到40（50的前一个刻度）后就要判断当前数据是否大于43了，如果大于43（返回全开区间的数据），就要停止读了。</p>

<p>整体下来我们只操作了大文件的很少一部分就得到了用户想要的数据。</p>

<h2 id="缓冲区">缓冲区</h2>

<p>为了减少写入日志时大量的磁盘写，索引在append日志时，把buffer设置成了10k，系统默认应该是4k。</p>

<p>同理，为了提高读取日志的效率，读取的buffer也设置了10k，也需要根据你日志的大小做适当调整。</p>

<p>索引的读写设置成了行buffer，每满一行都要flush到磁盘上，防止读到不完整的索引行（其实实践证明，设置了行buffer，还是能读到半拉的行）。</p>

<h2 id="查询">查询</h2>

<p>啥？要支持SQL，别闹了，100行代码怎么支持SQL呀。</p>

<p>现在查询是直接传入一个lambada表达式，系统遍历指定时间范围内的数据行时，满足用户的lambada条件才会返回给用户。</p>

<p>当然这样会多读取很多用户不需要的数据，而且每行都要进行lambda表达式的运算，不过没办法，简单就是美呀。</p>

<p>以前我是把一个需要查询的条件和日志时间，日志文件偏移量都记录在索引里，这样从索引里查找出符合条件的偏移量，然后每条数据都如日志文件里seek一次，read一
次。这样好处只有一个，就是读取的数据量少了，但缺点有两个：</p>

<p>索引文件特别大，不方便加载到内存中</p>

<p>每次读取都要先seek，貌似缓冲区用不上，特别慢，比连续读一个段的数据，并用lambda过滤慢四五倍</p>

<h2 id="写入">写入</h2>

<p>前面说过了，只append，不修改数据，而且每行日志最前面是时间戳。</p>

<p>多线程</p>

<p>查询数据，可以多线程同时查询，每次查询都会打开一个新的日志文件的描述符，所以并行的多个读取不会打架。</p>

<p>写入的话，虽然只是append操作，但不确认多线程对文件进行append操作是否安全，所以建议用一个队列，一个专用线程进行写入。</p>

<h2 id="锁">锁</h2>

<p>没有任何锁。</p>

<h2 id="排序">排序</h2>

<p>默认查询出来的数据是按时间正序排列，如需其它排序，可取到内存后用python的sorted函数排序，想怎么排就怎么排。</p>

<h2 id="100多行的数据库代码">100多行的数据库代码</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code>
    <span class="c"># -*- coding:utf-8 -*-</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">bisect</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">import</span> <span class="nn">logging</span>

    <span class="n">default_data_dir</span> <span class="o">=</span> <span class="s">'./data/'</span>
    <span class="n">default_write_buffer_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">10</span>
    <span class="n">default_read_buffer_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">10</span>
    <span class="n">default_index_interval</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="k">def</span> <span class="nf">ensure_data_dir</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">default_data_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">default_data_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
        <span class="n">ensure_data_dir</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">WawaIndex</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp_index</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_data_dir</span><span class="p">,</span> <span class="n">index_name</span> <span class="o">+</span> <span class="s">'.index'</span><span class="p">),</span> <span class="s">'a+'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_count</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_index</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__update_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__load_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp_index</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp_index</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">offset</span>  <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__update_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="c"># 索引如果没有flush的话，可能读到有半行的数据</span>
                    <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">append_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_count</span> <span class="o">%</span> <span class="n">default_index_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp_index</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">get_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin_key</span><span class="p">,</span> <span class="n">end_key</span><span class="p">):</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">begin_key</span><span class="p">))</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_key</span><span class="p">))</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">right</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">right</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">right</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'get_index_range:</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">begin_key</span><span class="p">,</span> <span class="n">end_key</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">left</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>


    <span class="k">class</span> <span class="nc">WawaDB</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> <span class="n">db_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp_data_for_append</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_data_dir</span><span class="p">,</span> <span class="n">db_name</span> <span class="o">+</span> <span class="s">'.db'</span><span class="p">),</span> <span class="s">'a'</span><span class="p">,</span> <span class="n">default_write_buffer_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">WawaIndex</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__get_data_by_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin_key</span><span class="p">,</span> <span class="n">end_key</span><span class="p">,</span> <span class="n">begin_offset</span><span class="p">,</span> <span class="n">end_offset</span><span class="p">):</span>
            <span class="n">fp_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">+</span> <span class="s">'.db'</span><span class="p">),</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">default_read_buffer_size</span><span class="p">)</span>
            <span class="n">fp_data</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">begin_offset</span><span class="p">))</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">fp_data</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">find_real_begin_offset</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">will_read_len</span><span class="p">,</span> <span class="n">read_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_offset</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">begin_offset</span><span class="p">),</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">read_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">find_real_begin_offset</span><span class="p">)</span> <span class="ow">and</span>  <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">begin_key</span><span class="p">)):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">fp_data</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="n">find_real_begin_offset</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">read_len</span> <span class="o">&gt;=</span> <span class="n">will_read_len</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_key</span><span class="p">)):</span> <span class="k">break</span>
                <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">fp_data</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">append_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">record_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
            <span class="k">def</span> <span class="nf">check_args</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'data is null'</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'data is not string'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'</span><span class="se">\r</span><span class="s">'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'data contains linesep'</span><span class="p">)</span>

            <span class="n">check_args</span><span class="p">()</span>

            <span class="n">record_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">record_time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s">'</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">record_time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp_data_for_append</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp_data_for_append</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">append_index</span><span class="p">(</span><span class="n">record_time</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">data_filter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">check_args</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'begin_time or end_time is not datetime'</span><span class="p">)</span>

            <span class="n">check_args</span><span class="p">()</span>

            <span class="n">begin_time</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">begin_time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()),</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">end_time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
            <span class="n">begin_offset</span><span class="p">,</span> <span class="n">end_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_offsets</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_data_by_offsets</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">begin_offset</span><span class="p">,</span> <span class="n">end_offset</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data_filter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data_filter</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
        <span class="kn">import</span> <span class="nn">uuid</span><span class="o">,</span> <span class="nn">random</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">time_test</span><span class="p">(</span><span class="n">test_name</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">inner2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">'</span><span class="si">%</span><span class="s">s take time:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">return</span> <span class="n">inner2</span>
            <span class="k">return</span> <span class="n">inner</span>

        <span class="nd">@time_test</span><span class="p">(</span><span class="s">'gen_test_data'</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">gen_test_data</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">begin_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">begin_time</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">begin_time</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">))</span><span class="o">+</span> <span class="s">' '</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()),</span> <span class="n">begin_time</span><span class="p">)</span>
                <span class="n">begin_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="nd">@time_test</span><span class="p">(</span><span class="s">'test_get_data'</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">test_get_data</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
            <span class="n">begin_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">begin_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'1024'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">'test_get_data get </span><span class="si">%</span><span class="s">s results'</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="nd">@time_test</span><span class="p">(</span><span class="s">'get_db'</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get_db</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">WawaDB</span><span class="p">(</span><span class="s">'test'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'./data/test.db'</span><span class="p">):</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
            <span class="n">gen_test_data</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="c">#db.index.fp_index.flush()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
        <span class="n">test_get_data</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="n">init</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">test</span><span class="p">()</span>
</code></pre>
</div>

<ul>
  <li>以上代码经过验证可以直接拿去修改调用</li>
  <li>Owner <code class="highlighter-rouge">breakEval13</code></li>
  <li>https://github.com/breakEval13</li>
</ul>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      
  
      
        
        <!-- Disqus Protection, see https://github.com/mzlogin/mzlogin.github.io/issues/2 -->
        
        
          <div id="disqus_thread"></div>
          <script>
            var disqus_config = function () {
              this.page.url = 'http://firsh.me/2017/08/07/python-laladb/';
              this.page.identifier = '/2017/08/07/python-laladb/';
              this.page.title = 'Python 写一个简易的数据库.';
            };
            (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');

              s.type = 'text/javascript';
              s.async = true;
              var shortname = 'zmatsh';

              s.src = '//' + shortname + '.disqus.com/embed.js';

              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        
        
      
    


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
    <button class="btn btn-default" id="site_search_do"><span class="octicon octicon-search"></span></button>
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="https://zmatsh.b0.upaiyun.com/assets/css/modules/sidebar-search.css">
<script src="https://zmatsh.b0.upaiyun.com/assets/js/lunr.min.js"></script>
<script src="https://zmatsh.b0.upaiyun.com/assets/js/search.js"></script>


    
<h3>Post Directory</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>
<script src="https://zmatsh.b0.upaiyun.com/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="uk0">uk0</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="http://github.com/uk0/uk0.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="/" title="Index" target="">Index</a>
                </li>
                
                <li>
                    <a href="/categories/" title="categories" target="">categories</a>
                </li>
                
                <li>
                    <a href="/open-source/" title="open-source" target="">open-source</a>
                </li>
                
                <li>
                    <a href="/wiki/" title="wiki" target="">wiki</a>
                </li>
                
                <li>
                    <a href="/links/" title="links" target="">links</a>
                </li>
                
                <li>
                    <a href="/about/" title="about" target="">about</a>
                </li>
                
                <li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="https://zmatsh.b0.upaiyun.com/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="https://zmatsh.b0.upaiyun.com/assets/js/geopattern.js"></script>
    <script src="https://zmatsh.b0.upaiyun.com/assets/js/prism.js"></script>
    <link rel="stylesheet" href="https://zmatsh.b0.upaiyun.com/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
    <div style="display:none">
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-80669434-1', 'auto');
        ga('send', 'pageview');

      </script>
    </div>
    
</body>
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</html>
