<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="http://jekyllrb.com" version="3.4.2">Jekyll</generator><link href="http://firsh.me/feed.xml" rel="self" type="application/atom+xml" /><link href="http://firsh.me/" rel="alternate" type="text/html" /><updated>2017-12-26T18:27:14+08:00</updated><id>http://firsh.me/</id><title type="html">山脚下的胖子.</title><subtitle>Flink，张建新技术博客，Kubernetes技术，虚拟化技术，微服务，容器技术,docker,Github, Google Kubernetes, kubernetes, Flink,Graphx,Spark,docker。</subtitle><author><name>breakeval13</name></author><entry><title type="html">kubeless原创实验</title><link href="http://firsh.me/2017/12/26/kubeless-simple/" rel="alternate" type="text/html" title="kubeless原创实验" /><published>2017-12-26T01:13:11+08:00</published><updated>2017-12-26T01:13:11+08:00</updated><id>http://firsh.me/2017/12/26/kubeless-simple</id><content type="html" xml:base="http://firsh.me/2017/12/26/kubeless-simple/">&lt;h1 id=&quot;quick-start&quot;&gt;quick start&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;实验环境kubernetes 1.8&lt;/li&gt;
  &lt;li&gt;kubeless 3&lt;/li&gt;
  &lt;li&gt;docker 17-ce&lt;/li&gt;
  &lt;li&gt;kubeless-ui latest&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;部署function&quot;&gt;部署function&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
 kubeless &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;deploy get-python  --runtime python2.7 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                                --from-file hellowithdata.py&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                                --handler hellowithdata.handler &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                                --trigger-http

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;部署成功&quot;&gt;部署成功&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜  python git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; ✗ kubeless &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;ls
NAME      	NAMESPACE	HANDLER              	RUNTIME  	TYPE	TOPIC	DEPENDENCIES	STATUS
&lt;span class=&quot;k&quot;&gt;function  	&lt;/span&gt;default  	hello.handler        	python2.7	    	     	            	1/1 READY
get-python	default  	hellowithdata.handler	python2.7	HTTP	     	            	1/1 READY

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;ui查看&quot;&gt;UI查看&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/33632748-61ce-41ac-9ede-f9b9a0b2fc7f.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;用命令测试&quot;&gt;用命令测试&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/ff6ab7bd-2891-428d-b7f3-4975b07ae896.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;curl请求&quot;&gt;curl请求&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 将kubectl 代理到本地端口&lt;/span&gt;
kubectl proxy -p 8080 &amp;amp;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;测试&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
➜  python git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; ✗ curl -L --data &lt;span class=&quot;s1&quot;&gt;'{&quot;Another&quot;: &quot;Echo&quot;}'&lt;/span&gt; localhost:8080/api/v1/proxy/namespaces/default/services/get-python:function-port/ --header &lt;span class=&quot;s2&quot;&gt;&quot;Content-Type:application/json&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Another&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Echo&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;%

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;解答&quot;&gt;解答&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    --from-file &lt;span class=&quot;c&quot;&gt;# 可执行文件 .py&lt;/span&gt;
    --runtime &lt;span class=&quot;c&quot;&gt;#执行环境&lt;/span&gt;
    --handler &lt;span class=&quot;c&quot;&gt;# function 执行某个方法&lt;/span&gt;
    --trigger-http  &lt;span class=&quot;c&quot;&gt;# function 模式&lt;/span&gt;
    --runtime-image &lt;span class=&quot;c&quot;&gt;# 默认不需要（如果在离线状态可以指定本地已经存在的镜像）&lt;/span&gt;
    --trigger-topic &lt;span class=&quot;c&quot;&gt;# 个人理解是参数存放的topic 比如流处理 （存放到指定队列）&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>breakeval13</name></author><summary type="html">quick start</summary></entry><entry><title type="html">Serverless for Java development</title><link href="http://firsh.me/2017/12/25/2017-12-25-serverless-1/" rel="alternate" type="text/html" title="Serverless for Java development" /><published>2017-12-25T14:13:23+08:00</published><updated>2017-12-25T14:13:23+08:00</updated><id>http://firsh.me/2017/12/25/2017-12-25-serverless-1</id><content type="html" xml:base="http://firsh.me/2017/12/25/2017-12-25-serverless-1/">&lt;p&gt;Server Less 我的第一个简单的实例。&lt;/p&gt;

&lt;h1 id=&quot;前言&quot;&gt;前言&lt;/h1&gt;

&lt;p&gt;Serverless 适用场景：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1 运算密集 —— 如图片压缩、数据分析。因为使用 Serverless 方案同一秒里可以运行千上万个 Lambda，能轻易实现传统架构无法实现的超强处理能力，并且只在使用时收费。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2  为其它服务提供编程支持 —— 例如，当 AWS DynamoDB 数据发生变化时，调用 AWS Lambda 生成 PDF 报表。再如，为 AWS API Gateway 提供自定义权限验证脚本。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;3  定时任务 —— 以往使用 cron 编写的定时任务可以改用 AWS Lambda 实现，很明显的好处是任务不执行的时候完全不收费。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;4  瘦容器 —— 因为 AWS Lambda 本身基于 Docker 容器实现，Lambda 方法跑在 Amazon Linux AMI 中，虽然官方支持的编程语言只有 NodeJS、Java、Python，但其实可以用 NodeJS 的 shim 运行大部分能在 Linux 下运行的程序。以至于有人用这个特性做了 LambCI 这种脑洞大开的 Serverless CI 服务。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;5   无人运维 —— Serverless 的核心优势就是不需要管理服务器，自伸缩的特性如果用传统方案解决会相对复杂很多。如果你需要一个服务为你跑好几年，期间完全不需要担心它的服务器运行情况，Serverless 会是最好的选择。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;quick-start-fnproject&quot;&gt;quick start [fnproject]&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Docker ，fn cli ，nodejs&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;用到以下两个工具
   https://github.com/fnproject/fn &lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;https://github.com/fnproject/ui&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;brew install fn # 安装fn command命令行&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;执行fn start 启动 FN_Server
   &lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/574abd7a-5de7-4de3-ba11-84517eb23074.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;请求
   &lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/9b1eb8af-ccb5-415e-bc77-89e72c2dc05d.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;请求实例
   &lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/b8491fa5-4bd1-48ff-ac51-2151a096406a.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;coder&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;&lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/25648265-1603-4516-bab5-21e95b3c47d2.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;yaml 配置&lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;&lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/54eae79d-7c0b-422c-966f-3701f1dc40f2.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;deploy hello&lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;&lt;img src=&quot;http://zmatsh.b0.upaiyun.com/demos/f4c7ebb2-3674-49b5-9848-9f16d4390a73.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;kubeless-整理中&quot;&gt;kubeless [整理中]&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;kubeless function1.yaml&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
  &lt;span class=&quot;s&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;k8s.io/v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Function&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;function1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hello.foobar&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;registry.timeondata.com/firsh_demo/kubeless_runtime_python:2.7.1&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;runtime&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;python2.7&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;deps&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;|&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;cowpy&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;|&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;import time&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;import random&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;from cowpy import cow&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;def foobar():&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;# NB: delay will be negative and sleep will raise an error&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;# occasionally.  This is a feature for demoing errors.&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;delay = random.normalvariate(0.3, 0.2)&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;time.sleep(delay)&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;msg = &quot;hello world - with a %0.2fs artificial delay&quot; % delay&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;c = cow.get_cow()&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;return c().milk(msg)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;启动&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  ➜ python git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; ✗ kubectl create -f function1.yaml

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;检查启动&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;c&quot;&gt;# 检查启动&lt;/span&gt;
 ➜  python git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; ✗ kubeless &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;ls
NAME     	NAMESPACE	HANDLER     	RUNTIME  	TYPE	TOPIC	DEPENDENCIES	STATUS
function1	default  	hello.foobar	python2.7	    	     	cowpy       	1/1 READY
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;测试调用&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    kubeless &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;call  function1 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;结果&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
➜  python git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; ✗ kubeless &lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;call  function1
 _____________________________________________
&amp;lt; hello world - with a 0.42s artificial delay &amp;gt;
 ---------------------------------------------
     &lt;span class=&quot;se&quot;&gt;\ &lt;/span&gt;  ^__^
      &lt;span class=&quot;se&quot;&gt;\ &lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;oo&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt;______
         &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;__&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\ &lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\/\&lt;/span&gt;
           &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;----w |
           &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>breakeval13</name></author><summary type="html">Server Less 我的第一个简单的实例。</summary></entry><entry><title type="html">日常总结[我的时间线]@</title><link href="http://firsh.me/2017/12/20/demo-test/" rel="alternate" type="text/html" title="日常总结[我的时间线]@" /><published>2017-12-20T00:00:00+08:00</published><updated>2017-12-20T00:00:00+08:00</updated><id>http://firsh.me/2017/12/20/demo-test</id><content type="html" xml:base="http://firsh.me/2017/12/20/demo-test/">&lt;h1 id=&quot;总结日常遇到的问题以及解决办法总结每天遇到的问题&quot;&gt;总结日常遇到的问题，以及解决办法，总结每天遇到的问题。&lt;/h1&gt;

&lt;h1 id=&quot;2017-12-22--shell&quot;&gt;2017-12-22  [shell]&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;登陆服务器每次都输入密码很不舒服，所以总结了一个小脚本。&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;USER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;activemq
&lt;span class=&quot;nv&quot;&gt;current_node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.45
&lt;span class=&quot;nv&quot;&gt;PASSWD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;activemq
/usr/bin/expect &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
    spawn ssh $USER@$current_node
    expect &quot;*(yes/no)?*&quot; {
        send -- &quot;yes\r&quot;
        expect &quot;*?assword:*&quot;
        send -- &quot;$PASSWD\r&quot;
    }  &quot;*?assword:*&quot;
        send -- &quot;$PASSWD\r&quot;
        expect &quot;*# &quot;
    send -- &quot;exit \r&quot;
EOF

&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;# 2017-12-21  [shell]&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;用&lt;code class=&quot;highlighter-rouge&quot;&gt;,&lt;/code&gt;劈分数据。&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;HBASE_REGION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dscn1,dscn2,dscn3

&lt;span class=&quot;c&quot;&gt;#用 `,` split&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OLD_IFS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$IFS&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IFS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;,&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;arr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HBASE_REGION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IFS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$OLD_IFS&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;s &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;arr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[@]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;do
   &lt;/span&gt;ssh &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$s&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; ls
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content><author><name>breakeval13</name></author><summary type="html">总结日常遇到的问题，以及解决办法，总结每天遇到的问题。</summary></entry><entry><title type="html">Hadoop集群配置HA。</title><link href="http://firsh.me/2017/12/19/hadoop-install/" rel="alternate" type="text/html" title="Hadoop集群配置HA。" /><published>2017-12-19T00:00:00+08:00</published><updated>2017-12-19T00:00:00+08:00</updated><id>http://firsh.me/2017/12/19/hadoop-install</id><content type="html" xml:base="http://firsh.me/2017/12/19/hadoop-install/">&lt;h1 id=&quot;hadoop集群配置ha&quot;&gt;hadoop集群配置HA&lt;/h1&gt;

&lt;h1 id=&quot;准备&quot;&gt;准备&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;JDK1.8&lt;/li&gt;
  &lt;li&gt;NTP&lt;/li&gt;
  &lt;li&gt;zookeeper&lt;/li&gt;
  &lt;li&gt;NTPDATE&lt;/li&gt;
  &lt;li&gt;配置目录&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;scp -r zookeeper/ dscn&lt;span class=&quot;nv&quot;&gt;$:&lt;/span&gt;/home/zookeeper

scp -r hadoop/ dscn&lt;span class=&quot;nv&quot;&gt;$:&lt;/span&gt;/home/hadoop

mkdir  -p /home/program/hadoop/  data logs pids  &lt;span class=&quot;c&quot;&gt;# hadoop 文件路径&lt;/span&gt;

mkdir  -p  /home/program/zookeeper data logs pids &lt;span class=&quot;c&quot;&gt;# zookeeper 文件&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;hdfs haadmin -transitionToActive nn1 --forcemanual
解决启动节点都为 &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;standby&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;环境变量-hadoop&quot;&gt;环境变量 Hadoop&lt;/h1&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;
        export JAVA_HOME=/usr/java/jdk1.8.0_73
        export HADOOP_HOME=/home/dscs/hadoop
        export HADOOP_LOG_DIR=/home/program/hadoop/logs
        export HADOOP_PID_DIR=/home/program/hadoop/pids
        export HADOOP_IDENT_STRING=dscs
        export YARN_LOG_DIR=/home/program/hadoop/logs
        export YARN_PID_DIR=/home/program/hadoop/pids
        export YARN_IDENT_STRING=dscs
        export CLASSPATH=.:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$JAVA_HOME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/lib/dt.jar:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$JAVA_HOME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/lib/tools.jar
        PATH=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HADOOP_HOME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/bin:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HADOOP_HOME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/sbin:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$JAVA_HOME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/bin:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
        &quot;&lt;/span&gt; &amp;gt;&amp;gt;~/.bash_profile
    &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; ~/.bash_profile
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;环境变量-java&quot;&gt;环境变量 Java&lt;/h1&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;JAVA_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;dirname &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;dirname &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;readlink -f &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;which javac&lt;span class=&quot;k&quot;&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;zookeeper-config&quot;&gt;zookeeper config&lt;/h1&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
    &lt;span class=&quot;nv&quot;&gt;dataDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/program/zookeeper/data
    &lt;span class=&quot;nv&quot;&gt;dataLogDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/program/zookeeper/logs
    &lt;span class=&quot;nv&quot;&gt;clientPort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2181
    &lt;span class=&quot;nv&quot;&gt;tickTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000
    &lt;span class=&quot;nv&quot;&gt;initLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5
    &lt;span class=&quot;nv&quot;&gt;syncLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2
    server.1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dscn1:2888:3888
    server.2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dscn2:2888:3888
    server.3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dscn3:2888:3888

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;i &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;1 2 3
    &lt;span class=&quot;k&quot;&gt;do 

        &lt;/span&gt;ssh dscn&lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt; mkdir -p /home/program/zookeeper/data/ &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt; &amp;gt; /home/program/zookeeper/data/myid

    &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;hadoop-启动流程&quot;&gt;hadoop 启动流程&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;启动 zookeeper (3个节点)&lt;/p&gt;

    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; ```bash
     ./zkServer.sh start ../conf/zoo.cfg
 ```
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;启动 JournalNode (3个节点) 
     &lt;code class=&quot;highlighter-rouge&quot;&gt;bash
         sbin/hadoop-daemon.sh start journalnode
    &lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;在其中一个namenode上格式化：
     &lt;code class=&quot;highlighter-rouge&quot;&gt;bash
          bin/hdfs namenode -format -bjsxt 
    &lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;启动刚刚格式化的namenode:&lt;/p&gt;

    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; ```bash
     sbin/hadoop-daemon.sh start namenode
 ```
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在另一个没有格式化的namenode上执行&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;         bin/hdfs namenode -bootstrapStandby 
            
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;启动第二个namenode&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;      sbin/hadoop-daemon.sh start namenode
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;启动第二个datanode(3个节点)&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;      sbin/hadoop-daemon.sh start datanode
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;在其中一个namenode上初始化zkfc：&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;     bin/hdfs zkfc -formatZK
&lt;/code&gt;&lt;/pre&gt;
    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;启动 JobHistory&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    sbin/mr-jobhistory-daemon.sh start historyserver
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;# 异常描述&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Hadoop2.0的HA机制判断两者元数据不一致时，为了防止脑裂，所以使两者都处于standby状态,&lt;/li&gt;
  &lt;li&gt;场景：两台namenode都是standby。&lt;/li&gt;
  &lt;li&gt;zk集群里只是保存，hadoop集群的ha状态，而不保存数据，所以在ha机制出现问题时，可以使用此条命令：&lt;/li&gt;
  &lt;li&gt;停止集群 hadoop&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;        hdfs zkfc -formatZK
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;# 插曲 scp 发现存储不够了&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@dscn1 hadoop]# vgs
  VG   &lt;span class=&quot;c&quot;&gt;#PV #LV #SN Attr   VSize    VFree&lt;/span&gt;
  VG00   1  10   0 wz--n- &amp;lt;199.51g &amp;lt;1.26g


  lvextend -L +173G /dev/mapper/VG00-lvroot


  xfs_growfs /dev/mapper/VG00-lvroot

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;读取文件里面的文件路径参数转译&quot;&gt;读取文件里面的文件路径参数【转译】&lt;/h1&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;nv&quot;&gt;HBASE_TMP_DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;cat &lt;span class=&quot;nv&quot;&gt;$HBASE_PACKAGE_PATH&lt;/span&gt;/config | grep HBASE_TMP_DIR | awk -F &lt;span class=&quot;s2&quot;&gt;&quot;=&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{print$2}'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;HBASE_TMP_DIR_STR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HBASE_TMP_DIR&lt;/span&gt; | sed &lt;span class=&quot;s1&quot;&gt;'s#\/#\\\/#g'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;

sed -i &lt;span class=&quot;s2&quot;&gt;&quot;s/HBASE_TMP_DIR/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HBASE_TMP_DIR_STR&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HBASE_HOME&lt;/span&gt;/conf/hbase-site.xml

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;读取节点配置合理配置主从节点&quot;&gt;读取节点配置合理配置主从节点&lt;/h1&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;OLD_IFS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$IFS&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IFS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;,&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;arr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HBASE_REGION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IFS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$OLD_IFS&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;s &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;arr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[@]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$s&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &amp;gt;&amp;gt;&lt;span class=&quot;nv&quot;&gt;$HBASE_HOME&lt;/span&gt;/conf/regionservers
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content><author><name>breakeval13</name></author><summary type="html">hadoop集群配置HA</summary></entry><entry><title type="html">ehcache集群配置terracotta。</title><link href="http://firsh.me/2017/12/05/ehecache-terracotta/" rel="alternate" type="text/html" title="ehcache集群配置terracotta。" /><published>2017-12-05T00:00:00+08:00</published><updated>2017-12-05T00:00:00+08:00</updated><id>http://firsh.me/2017/12/05/ehecache-terracotta</id><content type="html" xml:base="http://firsh.me/2017/12/05/ehecache-terracotta/">&lt;h1 id=&quot;ehcache集群配置terracotta&quot;&gt;ehcache集群配置terracotta&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;ehcache for maven conf&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-xml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;        &lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.ehcache&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;ehcache&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;${ehcache.version}&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.ehcache&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;ehcache-clustered&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;${ehcache.version}&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;tc-config.xml (ehcache3.4.0)版本已经被合并了里面包含&lt;code class=&quot;highlighter-rouge&quot;&gt;terracotta&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-xml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;tc-config&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://www.terracotta.org/config&quot;&lt;/span&gt;
           &lt;span class=&quot;na&quot;&gt;xmlns:ohr=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://www.terracotta.org/config/offheap-resource&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
    This is the default Terracotta server configuration file for the Ehcache kit.

    It defines a single offheap resource of 512MB to be used for caching data.

    It also defines a single server, but you can add another one to benefit from high availability.
  --&amp;gt;&lt;/span&gt;

  &lt;span class=&quot;nt&quot;&gt;&amp;lt;plugins&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;config&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ohr:offheap-resources&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;ohr:resource&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;main&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;unit=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;MB&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;512&lt;span class=&quot;nt&quot;&gt;&amp;lt;/ohr:resource&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ohr:offheap-resources&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/config&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;/plugins&amp;gt;&lt;/span&gt;

  &lt;span class=&quot;nt&quot;&gt;&amp;lt;servers&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;server&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;host=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;10.11.0.224&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;s1&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
        Indicates the location for logs files - %H will resolve to user home directory.
        Note that relative path will be resolved from the location of this configuration file.
       --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;logs&amp;gt;&lt;/span&gt;/home/hadmin/data/logs/ehcache/ehcache-server/terracotta-logs-s1&lt;span class=&quot;nt&quot;&gt;&amp;lt;/logs&amp;gt;&lt;/span&gt;

      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
        This port is used by clients to communicate to the server.
        Its value is actually the default one and is thus omitted.
      --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;tsa-port&amp;gt;&lt;/span&gt;9410&lt;span class=&quot;nt&quot;&gt;&amp;lt;/tsa-port&amp;gt;&lt;/span&gt;

      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
        This port is used for server to server communication.
        Its value is actually the default one and is thus omitted.
      --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;tsa-group-port&amp;gt;&lt;/span&gt;9430&lt;span class=&quot;nt&quot;&gt;&amp;lt;/tsa-group-port&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/server&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;server&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;host=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;10.11.0.225&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;s2&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
                   Indicates the location for logs files - %H will resolve to user home directory.
        Note that relative path will be resolved from the location of this configuration file.
       --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;logs&amp;gt;&lt;/span&gt;/home/hadmin/data/logs/ehcache/ehcache-server/terracotta-logs-s2&lt;span class=&quot;nt&quot;&gt;&amp;lt;/logs&amp;gt;&lt;/span&gt;

      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
                   This port is used by clients to communicate to the server.
        Its value is actually the default one and is thus omitted.
      --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;tsa-port&amp;gt;&lt;/span&gt;9410&lt;span class=&quot;nt&quot;&gt;&amp;lt;/tsa-port&amp;gt;&lt;/span&gt;

      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
                   This port is used for server to server communication.
        Its value is actually the default one and is thus omitted.
      --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;tsa-group-port&amp;gt;&lt;/span&gt;9430&lt;span class=&quot;nt&quot;&gt;&amp;lt;/tsa-group-port&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/server&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
      Below a sample server definition that will give HA to the cluster if run on a different host.

      Servers know how to communicate between each others because each version of the config file on each host
      will list all servers in it.
    --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&amp;lt;!--&amp;lt;server host=&quot;otherhost&quot; name=&quot;other-server&quot;&amp;gt;--&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--&amp;lt;logs&amp;gt;logs&amp;lt;/logs&amp;gt;--&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;&amp;lt;!--&amp;lt;tsa-port&amp;gt;9410&amp;lt;/tsa-port&amp;gt;--&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&amp;lt;!--&amp;lt;/server&amp;gt;--&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
      Indicates how much time a server taking over after a failure in an active will wait
      to allow existing clients to reconnect. The time unit is seconds.
    --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;client-reconnect-window&amp;gt;&lt;/span&gt;120&lt;span class=&quot;nt&quot;&gt;&amp;lt;/client-reconnect-window&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;/servers&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/tc-config&amp;gt;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;以上的配置文件为两个节点&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;分别在两个节点上运行相应命令。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 1&lt;/span&gt;
nohup ./bin/start-tc-server.sh  -f conf/tc-config.xml  -n s1 &amp;amp;
&lt;span class=&quot;c&quot;&gt;# 2&lt;/span&gt;
nohup ./bin/start-tc-server.sh  -f conf/tc-config.xml  -n s2 &amp;amp;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;这样两台基本的Ehcache 服务集群就搭建成功了。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;文章写的比较着急，不忙了在继续整理，望理解。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;测试代码&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;

&lt;span class=&quot;kn&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;todcloud&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;utils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/**
 * Created by zhangjianxin on 2017/12/4.
 * Github Breakeval13
 * blog firsh.me
 */&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.net.URI&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.ehcache.Cache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.ehcache.CacheManager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;org.slf4j.Logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;URI&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;clustered&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;builders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ClusteredResourcePoolBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;clusteredDedicated&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;clustered&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;builders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ClusteringServiceConfigurationBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;cluster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;builders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;CacheConfigurationBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;newCacheConfigurationBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;builders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;CacheManagerBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;newCacheManagerBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;builders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ResourcePoolsBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;heap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ehcache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;units&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;MemoryUnit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;MB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;slf4j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;LoggerFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getLogger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ClusteredProgrammatic&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Logger&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOGGER&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getLogger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ClusteredProgrammatic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;LOGGER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Creating clustered cache manager&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URI&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;terracotta://10.11.0.224:9410/s1&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CacheManager&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cacheManager&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCacheManagerBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;autoCreate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;defaultServerResource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;withCache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;basicCache&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;newCacheConfigurationBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;heap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;offheap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clusteredDedicated&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))))&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Cache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;basicCache&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cacheManager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getCache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;basicCache&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

            &lt;span class=&quot;n&quot;&gt;LOGGER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Putting to cache&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//            basicCache.put(100L, &quot;da one!&quot;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//            basicCache.put(1L, &quot;da one1L!&quot;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;basicCache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1L&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;LOGGER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Closing cache manager&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;LOGGER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Exiting&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content><author><name>breakeval13</name></author><summary type="html">ehcache集群配置terracotta</summary></entry><entry><title type="html">Mongodb Aggregate Sum。</title><link href="http://firsh.me/2017/11/29/mongo-search-sum/" rel="alternate" type="text/html" title="Mongodb Aggregate Sum。" /><published>2017-11-29T00:00:00+08:00</published><updated>2017-11-29T00:00:00+08:00</updated><id>http://firsh.me/2017/11/29/mongo-search-sum</id><content type="html" xml:base="http://firsh.me/2017/11/29/mongo-search-sum/">&lt;h1 id=&quot;mongodb-search-aggregate-sum&quot;&gt;Mongodb search aggregate SUM&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;find aggregate and where&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
db.cabinet.aggregate&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;nv&quot;&gt;$group&lt;/span&gt;:
         &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           _id: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
           totalAmount: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$sum&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cabinetBoxTotal&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
           count: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$sum&lt;/span&gt;: 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

db.cabinet.aggregate&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
       &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$match&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; cabinetName : &lt;span class=&quot;s2&quot;&gt;&quot;中国农业大学西校区2号柜&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  
     &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;nv&quot;&gt;$group&lt;/span&gt;:
         &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           _id: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;,
           totalAmount: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$sum&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$cabinetBoxTotal&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
           count: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$sum&lt;/span&gt;: 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content><author><name>breakeval13</name></author><summary type="html">Mongodb search aggregate SUM</summary></entry><entry><title type="html">docker run Oracle11g。</title><link href="http://firsh.me/2017/11/29/docker-oracle11g/" rel="alternate" type="text/html" title="docker run Oracle11g。" /><published>2017-11-29T00:00:00+08:00</published><updated>2017-11-29T00:00:00+08:00</updated><id>http://firsh.me/2017/11/29/docker-oracle11g</id><content type="html" xml:base="http://firsh.me/2017/11/29/docker-oracle11g/">&lt;h1 id=&quot;oracle-running-for-docker&quot;&gt;oracle running for docker&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;find aggregate&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  -p 49160:22 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  -p 49161:1521 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  -p 8080:8080 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  -e &lt;span class=&quot;nv&quot;&gt;ORACLE_ENABLE_XDB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  -e &lt;span class=&quot;nv&quot;&gt;ORACLE_ALLOW_REMOTE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  -e &lt;span class=&quot;nv&quot;&gt;ORACLE_PASSWORD_VERIFY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;  &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/images/oracle.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;installationwith-ubuntu-1604&quot;&gt;Installation(with Ubuntu 16.04)&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker pull wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Run with 22 and 1521 ports opened:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d -p 49160:22 -p 49161:1521 wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Run this, if you want the database to be connected remotely:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d -p 49160:22 -p 49161:1521 -e ORACLE_ALLOW_REMOTE=true wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;By default, the password verification is disable(password never expired). If you want it back, run this:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d -p 49160:22 -p 49161:1521 -e ORACLE_PASSWORD_VERIFY=true wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/images/oracle2.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For performance concern, you may want to disable the disk asynch IO:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d -p 49160:22 -p 49161:1521 -e ORACLE_DISABLE_ASYNCH_IO=true wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;For XDB user, run this:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run -d -p 49160:22 -p 49161:1521 -p 8080:8080 -e ORACLE_ENABLE_XDB=true wnameless/oracle-xe-11g
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Check if localhost:8080 work&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XGET &quot;http://localhost:8080&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;You will show&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;TITLE&amp;gt;&lt;/span&gt;401 Unauthorized&lt;span class=&quot;nt&quot;&gt;&amp;lt;/TITLE&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;&amp;lt;H1&amp;gt;&lt;/span&gt;Unauthorized&lt;span class=&quot;nt&quot;&gt;&amp;lt;/H1&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Login http://localhost:8080 with following credential:
username: XDB
password: xdb
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Connect database with following setting:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;hostname: localhost
port: 49161
sid: xe
username: system
password: oracle
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Password for SYS &amp;amp; SYSTEM&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;oracle
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Login by SSH&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh root@localhost -p 49160
password: admin
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Support custom DB Initialization&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Dockerfile
FROM wnameless/oracle-xe-11g

ADD init.sql /docker-entrypoint-initdb.d/
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/images/oracle3.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;</content><author><name>breakeval13</name></author><summary type="html">oracle running for docker</summary></entry><entry><title type="html">为流处理加上一层高性能缓存。</title><link href="http://firsh.me/2017/11/22/geode-install/" rel="alternate" type="text/html" title="为流处理加上一层高性能缓存。" /><published>2017-11-22T00:00:00+08:00</published><updated>2017-11-22T00:00:00+08:00</updated><id>http://firsh.me/2017/11/22/geode-install</id><content type="html" xml:base="http://firsh.me/2017/11/22/geode-install/">&lt;h1 id=&quot;apache-geode-install&quot;&gt;Apache geode install&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;下载二进制文件&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://apache.osuosl.org/geode/1.3.0/apache-geode-1.3.0.zip

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;复制到其他多个节点进行解压&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
unzip apache-geode-1.3.0.zip

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;修改为集群模式（注意：支持的模式有分组模式，集群模式，集群+分组模式）&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;二进制文件所在 &lt;code class=&quot;highlighter-rouge&quot;&gt;/home/hadmin/geode/&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;创建相应的配置文件路径&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir -p cluster_config/cluster
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;将&lt;code class=&quot;highlighter-rouge&quot;&gt;/home/hadmin/geode/config&lt;/code&gt;内的文件复制到刚才创建的目录内，并且进行相应的修改文件名。&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
gemfire.properties	mv -&amp;gt; cluster.properties

cache.xml	mv -&amp;gt; cluster.xml

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;结果&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@dscn022 geode]# ls cluster_config/cluster/
cluster.properties  cluster.xml

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;启动主节点 locator&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;其他节点 connect –locator=10.11.0.224[10334]&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
create region --name=example-region --type=REPLICATE_PERSISTENT

start server --name=server1 --server-port=40411
start server --name=server2 --server-port=40412
start server --name=server3 --server-port=40413
start server --name=server4 --server-port=40414
start server --name=server5 --server-port=40415

query --query=&quot; SELECT  * FROM /example-region h WHERE h.hoursPerWeek &amp;lt; 40 &quot;



locator 定位器，相当于master-slave中的master，或者zookeeper，主要用于管理集群，和链接不同的server。

　　gfsh&amp;gt; start locator --name=locator1

server 服务器，可以部署在同一台机器，也可以部署在不同机器。在不同的机器上启动时，需要先用connect连接已启动的locator

　　connect --locator=ip[locator的port]

　　start server --name=server1

region 数据区域，或者叫表，是数据存储的基本单位，以下创建一个在集群内自动复制的，自动持久化的region，并持久化数据

　　create region --name=regionA --type=REPLICATE_PERSISTENT

　　put --region=regionA --key=&quot;1&quot; --value=&quot;one&quot;

OQL 类SQL的脚本，用来查数

　　query --query=&quot;select * from /regionA&quot;

以上命令的执行默认是以集群为范围的，如果要单机执行，需要修改apache-geode\config\gemfire.properties文件中的属性：enable-cluster-configuration=true，改为false。



gfsh show missing-disk-stores 查询 disk 


start server --name=server13 --locators=10.11.0.224[10334]

start server --name=server20 --server-port=40431  --locators=10.11.0.224[10334]

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content><author><name>breakeval13</name></author><summary type="html">Apache geode install</summary></entry><entry><title type="html">Teleport 跳板机部署[转载漠然]</title><link href="http://firsh.me/2017/11/09/set-up-teleport/" rel="alternate" type="text/html" title="Teleport 跳板机部署[转载漠然]" /><published>2017-11-09T16:47:51+08:00</published><updated>2017-11-09T16:47:51+08:00</updated><id>http://firsh.me/2017/11/09/set-up-teleport</id><content type="html" xml:base="http://firsh.me/2017/11/09/set-up-teleport/">&lt;blockquote&gt;
  &lt;p&gt;由于业务需求，以前账号管理混乱，所以很多人有生产服务器的 root 权限；所以目前需要一个能 ssh 登录线上服务器的工具，同时具有简单的审计功能；找了好久找到了这个小工具，以下记录一下搭建教程&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;一环境准备&quot;&gt;一、环境准备&lt;/h3&gt;

&lt;p&gt;目前准备了 3 台虚拟机，两台位于内网 NAT 之后，一台位于公网可以直接链接；使用时客户端通过工具连接到公网跳板机上，然后实现自动跳转到内网任意主机；并且具有相应的操作回放审计，通过宿主机账户限制用户权限&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;ip&lt;/th&gt;
      &lt;th&gt;节点&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;92.223.67.84&lt;/td&gt;
      &lt;td&gt;公网 Master&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;172.16.0.80&lt;/td&gt;
      &lt;td&gt;内网 Master&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;172.16.0.81&lt;/td&gt;
      &lt;td&gt;内网 Node&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;二teleport-工作模式&quot;&gt;二、Teleport 工作模式&lt;/h3&gt;

&lt;p&gt;Teleport 工作时从宏观上看是以集群为单位，也就是说&lt;strong&gt;公网算作一个集群，内网算作另一个集群，内网集群通过 ssh 隧道保持跟公网的链接状态，同时内网机群允许公网集群用户连接&lt;/strong&gt;，大体工作模式如下&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/markdown/hsnj8.png&quot; alt=&quot;Teleport 工作模式&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;三搭建公网-master&quot;&gt;三、搭建公网 Master&lt;/h3&gt;

&lt;h4 id=&quot;31配置-systemd&quot;&gt;3.1、配置 Systemd&lt;/h4&gt;

&lt;p&gt;首先下载相关可执行文件并复制到 Path 目录下，然后创建一下配置目录等&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/gravitational/teleport/releases/download/v2.3.5/teleport-v2.3.5-linux-amd64-bin.tar.gz
tar -zxvf teleport-v2.3.5-linux-amd64-bin.tar.gz
mv teleport/tctl teleport/teleport teleport/tsh /usr/local/bin
mkdir -p /etc/teleport /data/teleport
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后为了让服务后台运行创建一个 systemd service 配置文件&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat &amp;gt; /etc/systemd/system/teleport.service &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
[Unit]
Description=Teleport SSH Service
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=/usr/local/bin/teleport start -c /etc/teleport/teleport.yaml

[Install]
WantedBy=multi-user.target
EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;32配置-teleport&quot;&gt;3.2、配置 Teleport&lt;/h4&gt;

&lt;p&gt;Systemd 配置完成后，就需要写一个 Teleport 的配置文件来让 Teleport 启动，具体选项含义可以参考 &lt;a href=&quot;https://gravitational.com/teleport/docs/2.3/admin-guide/&quot;&gt;官方文档&lt;/a&gt;；以下为我的配置样例&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# By default, this file should be stored in /etc/teleport.yaml&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section of the configuration file applies to all teleport&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# services.&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;teleport&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# nodename allows to assign an alternative name this node can be reached by.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# by default it's equal to hostname&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;nodename&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mritd.master&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Data directory where Teleport keeps its data, like keys/users for&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# authentication (if using the default BoltDB back-end)&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;data_dir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/data/teleport&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# one-time invitation token used to join a cluster. it is not used on&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# subsequent starts&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;auth_token&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;jYektagNTmhjv9Dh&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# when running in multi-homed or NATed environments Teleport nodes need&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# to know which IP it will be reachable at by other nodes&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;advertise_ip&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;92.223.67.84&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# list of auth servers in a cluster. you will have more than one auth server&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# if you configure teleport auth to run in HA configuration&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;auth_servers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3025&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3025&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Teleport throttles all connections to avoid abuse. These settings allow&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# you to adjust the default limits&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;connection_limits&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;max_connections&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1000&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;max_users&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;250&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Logging configuration. Possible output values are 'stdout', 'stderr' and&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# 'syslog'. Possible severity values are INFO, WARN and ERROR (default).&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;stdout&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;severity&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;INFO&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Type of storage used for keys. You need to configure this to use etcd&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# backend if you want to run Teleport in HA configuration.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;storage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bolt&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Cipher algorithms that the server supports. This section only needs to be&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# set if you want to override the defaults.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;ciphers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes128-ctr&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes192-ctr&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes256-ctr&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes128-gcm@openssh.com&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;arcfour256&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;arcfour128&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Key exchange algorithms that the server supports. This section only needs&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# to be set if you want to override the defaults.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;kex_algos&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;curve25519-sha256@libssh.org&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ecdh-sha2-nistp256&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ecdh-sha2-nistp384&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ecdh-sha2-nistp521&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;diffie-hellman-group14-sha1&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;diffie-hellman-group1-sha1&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Message authentication code (MAC) algorithms that the server supports.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# This section only needs to be set if you want to override the defaults.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;mac_algos&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha2-256-etm@openssh.com&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha2-256&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha1&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha1-96&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section configures the 'auth service':&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;auth_service&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Turns 'auth' role on. Default is 'yes'&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

    &lt;span class=&quot;s&quot;&gt;authentication&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# default authentication type. possible values are 'local', 'oidc' and 'saml'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# only local authentication (Teleport's own user DB) is supported in the open&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# source version&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;local&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# second_factor can be off, otp, or u2f&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;second_factor&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;otp&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# this section is used if second_factor is set to 'u2f'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#u2f:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    # app_id must point to the URL of the Teleport Web UI (proxy) accessible&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    # by the end users&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    app_id: https://localhost:3080&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    # facets must list all proxy servers if there are more than one deployed&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    facets:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    - https://localhost:3080&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# IP and the port to bind to. Other Teleport nodes will be connecting to&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# this port (AKA &quot;Auth API&quot; or &quot;Cluster API&quot;) to validate client&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# certificates&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3025&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Pre-defined tokens for adding new nodes to a cluster. Each token specifies&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# the role a new node will be allowed to assume. The more secure way to&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# add nodes is to use `ttl node add --ttl` command to generate auto-expiring&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# tokens.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# We recommend to use tools like `pwgen` to generate sufficiently random&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# tokens of 32+ byte length.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;tokens&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;proxy,node:jYektagNTmhjv9Dh&quot;&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;auth:jYektagNTmhjv9Dh&quot;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Optional &quot;cluster name&quot; is needed when configuring trust between multiple&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# auth servers. A cluster name is used as part of a signature in certificates&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# generated by this CA.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# By default an automatically generated GUID is used.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# IMPORTANT: if you change cluster_name, it will invalidate all generated&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# certificates and keys (may need to wipe out /var/lib/teleport directory)&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mritd&quot;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section configures the 'node service':&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;ssh_service&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Turns 'ssh' role on. Default is 'yes'&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# IP and the port for SSH service to bind to.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3022&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# See explanation of labels in &quot;Labeling Nodes&quot; section below&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;role&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# List of the commands to periodically execute. Their output will be used as node labels.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# See &quot;Labeling Nodes&quot; section below for more information.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;arch&lt;/span&gt;             &lt;span class=&quot;c1&quot;&gt;# this command will add a label like 'arch=x86_64' to a node&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uname&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;-p&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1h0m0s&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# enables reading ~/.tsh/environment before creating a session. by default&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# set to false, can be set true here or as a command line flag.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;permit_user_env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section configures the 'proxy servie'&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;proxy_service&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Turns 'proxy' role on. Default is 'yes'&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# SSH forwarding/proxy address. Command line (CLI) clients always begin their&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# SSH sessions by connecting to this port&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3023&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Reverse tunnel listening address. An auth server (CA) can establish an&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# outbound (from behind the firewall) connection to this address.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# This will allow users of the outside CA to connect to behind-the-firewall&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# nodes.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;tunnel_listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3024&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# The HTTPS listen address to serve the Web UI and also to authenticate the&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# command line (CLI) users via password+HOTP&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;web_listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:3080&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# TLS certificate for the HTTPS connection. Configuring these properly is&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# critical for Teleport security.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#https_key_file: /var/lib/teleport/webproxy_key.pem&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#https_cert_file: /var/lib/teleport/webproxy_cert.pem&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后启动 Teleport 即可&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;teleport
systemctl start teleport
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;如果启动出现如下错误&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;error: Could not load host key: /etc/ssh/ssh_host_ecdsa_key
error: Could not load host key: /etc/ssh/ssh_host_ed25519_key
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;请执行 ssh-keygen 命令自行生成相关秘钥&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh-keygen -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key
ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;33添加用户&quot;&gt;3.3、添加用户&lt;/h4&gt;

&lt;p&gt;公网这台 Teleport 将会作为主要的接入机器，所以在此节点内添加的用户将有权限登录所有集群，包括内网的另一个集群；所以为了方便以后操作先添加一个用户&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 添加一个用户名为 mritd 的用户，该用户在所有集群具有 root 用户权限&lt;/span&gt;
tctl --config /etc/teleport/teleport.yaml users add mritd root
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;添加成功后会返回一个 OTP 认证初始化地址，浏览器访问后可以使用 Google 扫描 OTP 二维码从而在登录时增加一层 OTP 认证&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/markdown/chuyf.png&quot; alt=&quot;OTP CMD&quot; /&gt;&lt;/p&gt;

&lt;p&gt;访问该地址后初始化密码及 OTP&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/markdown/czwmd.png&quot; alt=&quot;init OTP&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;四搭建内网-master&quot;&gt;四、搭建内网 Master&lt;/h3&gt;

&lt;p&gt;内网搭建 Master 和公网类似，只不过为了安全将所有 &lt;code class=&quot;highlighter-rouge&quot;&gt;0.0.0.0&lt;/code&gt; 的地址全部换成内网 IP 即可，以下为内网的配置信息&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# By default, this file should be stored in /etc/teleport.yaml&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section of the configuration file applies to all teleport&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# services.&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;teleport&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# nodename allows to assign an alternative name this node can be reached by.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# by default it's equal to hostname&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;nodename&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mritd.test1&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Data directory where Teleport keeps its data, like keys/users for&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# authentication (if using the default BoltDB back-end)&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;data_dir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/data/teleport&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# one-time invitation token used to join a cluster. it is not used on&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# subsequent starts&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;auth_token&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;jYektagNTmhjv9Dh&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# when running in multi-homed or NATed environments Teleport nodes need&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# to know which IP it will be reachable at by other nodes&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;advertise_ip&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# list of auth servers in a cluster. you will have more than one auth server&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# if you configure teleport auth to run in HA configuration&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;auth_servers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80:3025&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Teleport throttles all connections to avoid abuse. These settings allow&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# you to adjust the default limits&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;connection_limits&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;max_connections&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1000&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;max_users&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;250&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Logging configuration. Possible output values are 'stdout', 'stderr' and&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# 'syslog'. Possible severity values are INFO, WARN and ERROR (default).&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;output&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;stdout&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;severity&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;INFO&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Type of storage used for keys. You need to configure this to use etcd&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# backend if you want to run Teleport in HA configuration.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;storage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bolt&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Cipher algorithms that the server supports. This section only needs to be&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# set if you want to override the defaults. &lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;ciphers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes128-ctr&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes192-ctr&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes256-ctr&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;aes128-gcm@openssh.com&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;arcfour256&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;arcfour128&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Key exchange algorithms that the server supports. This section only needs&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# to be set if you want to override the defaults.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;kex_algos&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;curve25519-sha256@libssh.org&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ecdh-sha2-nistp256&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ecdh-sha2-nistp384&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ecdh-sha2-nistp521&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;diffie-hellman-group14-sha1&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;diffie-hellman-group1-sha1&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Message authentication code (MAC) algorithms that the server supports.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# This section only needs to be set if you want to override the defaults.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;mac_algos&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha2-256-etm@openssh.com&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha2-256&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha1&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hmac-sha1-96&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section configures the 'auth service':&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;auth_service&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Turns 'auth' role on. Default is 'yes'&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

    &lt;span class=&quot;s&quot;&gt;authentication&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# default authentication type. possible values are 'local', 'oidc' and 'saml'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# only local authentication (Teleport's own user DB) is supported in the open&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# source version&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;local&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# second_factor can be off, otp, or u2f&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;second_factor&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;otp&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# this section is used if second_factor is set to 'u2f'&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#u2f:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    # app_id must point to the URL of the Teleport Web UI (proxy) accessible&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    # by the end users&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    app_id: https://localhost:3080&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    # facets must list all proxy servers if there are more than one deployed&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    facets:&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;#    - https://localhost:3080&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# IP and the port to bind to. Other Teleport nodes will be connecting to&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# this port (AKA &quot;Auth API&quot; or &quot;Cluster API&quot;) to validate client&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# certificates&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80:3025&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Pre-defined tokens for adding new nodes to a cluster. Each token specifies&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# the role a new node will be allowed to assume. The more secure way to&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# add nodes is to use `ttl node add --ttl` command to generate auto-expiring&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# tokens.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# We recommend to use tools like `pwgen` to generate sufficiently random&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# tokens of 32+ byte length.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;tokens&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;proxy,node:jYektagNTmhjv9Dh&quot;&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;auth:jYektagNTmhjv9Dh&quot;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Optional &quot;cluster name&quot; is needed when configuring trust between multiple&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# auth servers. A cluster name is used as part of a signature in certificates&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# generated by this CA.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# By default an automatically generated GUID is used.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# IMPORTANT: if you change cluster_name, it will invalidate all generated&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# certificates and keys (may need to wipe out /var/lib/teleport directory)&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nat&quot;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section configures the 'node service':&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;ssh_service&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Turns 'ssh' role on. Default is 'yes'&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# IP and the port for SSH service to bind to.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80:3022&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# See explanation of labels in &quot;Labeling Nodes&quot; section below&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;role&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# List of the commands to periodically execute. Their output will be used as node labels.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# See &quot;Labeling Nodes&quot; section below for more information.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;arch&lt;/span&gt;             &lt;span class=&quot;c1&quot;&gt;# this command will add a label like 'arch=x86_64' to a node&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uname&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;-p&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1h0m0s&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# enables reading ~/.tsh/environment before creating a session. by default&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# set to false, can be set true here or as a command line flag.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;permit_user_env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This section configures the 'proxy servie'&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;proxy_service&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Turns 'proxy' role on. Default is 'yes'&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# SSH forwarding/proxy address. Command line (CLI) clients always begin their&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# SSH sessions by connecting to this port&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80:3023&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Reverse tunnel listening address. An auth server (CA) can establish an&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# outbound (from behind the firewall) connection to this address.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# This will allow users of the outside CA to connect to behind-the-firewall&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# nodes.&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;tunnel_listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80:3024&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# The HTTPS listen address to serve the Web UI and also to authenticate the&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# command line (CLI) users via password+HOTP&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;web_listen_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;172.16.0.80:3080&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# TLS certificate for the HTTPS connection. Configuring these properly is&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# critical for Teleport security.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#https_key_file: /var/lib/teleport/webproxy_key.pem&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#https_cert_file: /var/lib/teleport/webproxy_cert.pem&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;配置完成后直接启动即可&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;teleport
systemctl start teleport
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;五将内网集群链接至公网&quot;&gt;五、将内网集群链接至公网&lt;/h3&gt;

&lt;p&gt;上文已经讲过，Teleport 通过公网链接内网主机的方式是让内网集群向公网打通一条 ssh 隧道，然后再进行通讯；具体配置如下&lt;/p&gt;

&lt;h4 id=&quot;51公网-master-开启授信集群&quot;&gt;5.1、公网 Master 开启授信集群&lt;/h4&gt;

&lt;p&gt;在公网 Master 增加 Token 配置，以允许持有该 Token 的其他内网集群连接到此，修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/teleport/teleport.yaml&lt;/code&gt; 增加一个 token 即可&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tokens:
    - &lt;span class=&quot;s2&quot;&gt;&quot;proxy,node:jYektagNTmhjv9Dh&quot;&lt;/span&gt;
    - &lt;span class=&quot;s2&quot;&gt;&quot;auth:jYektagNTmhjv9Dh&quot;&lt;/span&gt;
    - &lt;span class=&quot;s2&quot;&gt;&quot;trusted_cluster:xiomwWcrKinFw4Vs&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后重启 Teleport&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl restart teleport
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;52内网-master-链接公网-master&quot;&gt;5.2、内网 Master 链接公网 Master&lt;/h4&gt;

&lt;p&gt;当公网集群开启了允许其他集群链接后，内网集群只需要创建配置进行连接即可，创建配置(cluster.yaml)如下&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# cluster.yaml&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;trusted_cluster&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v2&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# the trusted cluster name MUST match the 'cluster_name' setting of the&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# cluster&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;local_cluster&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# this field allows to create tunnels that are disabled, but can be enabled later.&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# the token expected by the &quot;main&quot; cluster:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;xiomwWcrKinFw4Vs&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# the address in 'host:port' form of the reverse tunnel listening port on the&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# &quot;master&quot; proxy server:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;tunnel_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;92.223.67.84:3024&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# the address in 'host:port' form of the web listening port on the&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# &quot;master&quot; proxy server:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;web_proxy_addr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;92.223.67.84:3080&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;执行以下命令使内网集群通过 ssh 隧道连接到公网集群&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tctl --config /etc/teleport/teleport.yaml create /etc/teleport/cluster.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;注意，如果在启动公网和内网集群时没有指定受信的证书( &lt;code class=&quot;highlighter-rouge&quot;&gt;https_cert_file&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;https_key_file&lt;/code&gt; )，那么默认 Teleport 将会生成一个自签名证书，此时在 create 受信集群时将会产生如下错误:&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;the trusted cluster uses misconfigured HTTP/TLS certificate
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;此时需要在 &lt;strong&gt;待添加集群(内网)&lt;/strong&gt; 启动时增加 &lt;code class=&quot;highlighter-rouge&quot;&gt;--insecure&lt;/code&gt; 参数，即 Systemd 配置修改如下&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Teleport SSH Service
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;always
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/teleport start --insecure -c /etc/teleport/teleport.yaml

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;然后再进行 create 就不会报错&lt;/p&gt;

&lt;h3 id=&quot;六添加其他节点&quot;&gt;六、添加其他节点&lt;/h3&gt;

&lt;p&gt;两台节点打通后，此时如果有其他机器则可以将其加入到对应集群中，以下以另一台内网机器为例&lt;/p&gt;

&lt;p&gt;由于在主节点 &lt;code class=&quot;highlighter-rouge&quot;&gt;auth_service&lt;/code&gt; 中已经预先指定了一个 static Token 用于其他节点加入( &lt;code class=&quot;highlighter-rouge&quot;&gt;proxy,node:jYektagNTmhjv9Dh&lt;/code&gt; )，所以其他节点只需要使用这个 Token 加入即可，在另一台内网主机上修改 Systemd 配置如下，然后启动即可&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Teleport SSH Service
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;always
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/teleport start --roles&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;node,proxy &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                                        --token&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;jYektagNTmhjv9Dh &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                                        --auth-server&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;172.16.0.80

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;此时在内网的 Master 上可以查看到 Node 已经加入&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;test1.node ➜ tctl --config /etc/teleport/teleport.yaml nodes ls
Hostname    UUID                                 Address          Labels
----------- ------------------------------------ ---------------- -----------------------
test2.node  abc786fe-9a60-4480-80f7-8edc20710e58 172.16.0.81:3022
mritd.test1 be9080fb-bdba-4823-9fb6-294e0b0dcce3 172.16.0.80:3022 &lt;span class=&quot;nv&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;x86_64,role&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;七连接测试&quot;&gt;七、连接测试&lt;/h3&gt;

&lt;h4 id=&quot;71web-测试&quot;&gt;7.1、Web 测试&lt;/h4&gt;

&lt;p&gt;Teleport 支持 Web 页面访问，直接访问 &lt;code class=&quot;highlighter-rouge&quot;&gt;https://公网IP:3080&lt;/code&gt;，然后登陆即可，登陆后如下&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/markdown/9yf6k.png&quot; alt=&quot;Web login&quot; /&gt;&lt;/p&gt;

&lt;p&gt;通过 Cluster 选项可以切换不同集群，点击后面的用户名可以选择不同用户登录到不同主机(用户授权在添加用户时控制)，登陆成功后如下&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/markdown/m7hz5.png&quot; alt=&quot;Login Success&quot; /&gt;&lt;/p&gt;

&lt;p&gt;通过 Teleport 进行的所有操作可以通过审计菜单进行操作回放&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://zmatsh.b0.upaiyun.com/markdown/c8a74.png&quot; alt=&quot;Audit&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;72命令行测试&quot;&gt;7.2、命令行测试&lt;/h4&gt;

&lt;p&gt;类 Uninx 系统下我们还是习惯使用终端登录，终端登录需要借助 Teleport 的命令行工具 &lt;code class=&quot;highlighter-rouge&quot;&gt;tsh&lt;/code&gt;，&lt;code class=&quot;highlighter-rouge&quot;&gt;tsh&lt;/code&gt; 在下载的 release 压缩版中已经有了，具体使用文档请自行 help 和参考官方文档，以下为简单的使用示例&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;登录跳板机: 短时间内只需要登录一次即可，登录时需要输入密码及 OTP 口令&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TELEPORT_PROXY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;92.223.67.84
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TELEPORT_USER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mritd
tsh login --insecure
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;登录主机: 完成上一步 login 后就可以免密码登录任意主机&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# cluster 名字是上面设置的，在 web 界面也能看到&lt;/span&gt;
tsh ssh --cluster nat root@test2.node
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;复制文件: &lt;strong&gt;复制文件时不显示进度，并非卡死&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tsh scp --cluster nat teleport-v2.3.5-linux-amd64-bin.tar.gz root@test2.node:/

&lt;span class=&quot;gp&quot;&gt;-&amp;gt; &lt;/span&gt;teleport-v2.3.5-linux-amd64-bin.tar.gz &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;16797035&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>breakeval13</name></author><summary type="html">由于业务需求，以前账号管理混乱，所以很多人有生产服务器的 root 权限；所以目前需要一个能 ssh 登录线上服务器的工具，同时具有简单的审计功能；找了好久找到了这个小工具，以下记录一下搭建教程</summary></entry><entry><title type="html">Linux 操作系统日常巡检[原创]</title><link href="http://firsh.me/2017/11/06/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%B8%B8%E5%B7%A1%E6%A3%80/" rel="alternate" type="text/html" title="Linux 操作系统日常巡检[原创]" /><published>2017-11-06T00:00:00+08:00</published><updated>2017-11-06T00:00:00+08:00</updated><id>http://firsh.me/2017/11/06/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%B8%B8%E5%B7%A1%E6%A3%80</id><content type="html" xml:base="http://firsh.me/2017/11/06/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%B8%B8%E5%B7%A1%E6%A3%80/">&lt;p&gt;Linux 操作系统日常巡检&lt;/p&gt;

&lt;p&gt;date：2017-10-06
author：杨然儿&lt;/p&gt;

&lt;h1 id=&quot;操作系统日常巡检&quot;&gt;操作系统日常巡检&lt;/h1&gt;

&lt;h1 id=&quot;0查询是否被攻击&quot;&gt;0.查询是否被攻击&lt;/h1&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;统计登录成功的IP
        last | awk '{ print $3}' | sort | uniq -c | sort -n
登录失败的IP
        lastb | awk '{ print $3}' | sort | uniq -c | sort -n
查看是否被攻击
        grep :x:0: /etc/passwd  --只返回一行
是否存在可疑登录
    登录成功的
        grep &quot;Accept&quot; /var/log/secure*|awk '{print $9 '=' $11}'|sort|uniq -c
    登录失败的
        grep &quot;Failed&quot; /var/log/secure*|awk '{print $9 '=' $11}'|sort|uniq -c
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;1查操作系统日志是否存在错误&quot;&gt;1.查操作系统日志是否存在错误:&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;more /var/log/messages|grep -E '[Ee]erro|fail|[Ww]arning'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;2查主机是否存在硬件错误&quot;&gt;2.查主机是否存在硬件错误&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dmesg|more
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;3文件使用率&quot;&gt;3.文件使用率&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;df -h
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;4检查是否存在僵尸进程&quot;&gt;4.检查是否存在僵尸进程&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ps -ef|grep defunct
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;5检查网关是否正确&quot;&gt;5.检查网关是否正确&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nr
ping  网关
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;6检查网络通信是否正常&quot;&gt;6.检查网络通信是否正常&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -ni
RX-DRP 值为0或者保持稳定
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;7查网络连接状态&quot;&gt;7.查网络连接状态&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -an|egrep 'ESTABLISHED|FIN_WAIT_1|FIN_WAIT_2|TIME_WAIT|CLOSING|CLOSE_WAIT|LAST_ACK'

netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;8查看是否丢包&quot;&gt;8.查看是否丢包&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat /proc/net/dev
注意：dropped:0==&amp;gt; 如果这个值不为 0 , 则说明有丢包现象
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;9网卡的工作状态&quot;&gt;9.网卡的工作状态&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ifconfig -a
如果网卡中状态无为down状态

ethtool eth1
ethtool -i eth1
iftop -B -n  -N -p
fftop -i eth1 -B -n  -N -p
查看网卡速度
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;10cpu是否存在瓶颈&quot;&gt;10.CPU是否存在瓶颈&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;.CPU IDel大于90％则OK
        top -i -n 1|grep id|awk '{print $8}'

.CPU load average 正常值：&amp;lt; CPU个数 * 核数 *0.7
        top -i -n 1|grep load|awk '{print $13}'

        一般来说只要每个CPU的当前活动进程数不大于3那么系统的性能就是良好的，
        如果每个CPU的任务数大于5，那么就表示这台机器的性能有严重问题。
        实际上这个进程数就是每个CPU的负载.
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;11检查内存是否充足&quot;&gt;11.检查内存是否充足&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;内存有足够空间
free -m

没有发生换页
vmstat 1 6
        如果 si 和so 的值总是不为零，则说明，swap 有很高的换页率
        如果 bi 和 bo 的值很高说明系统在进行大量的IO读些操作
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;12检查io&quot;&gt;12.检查IO&lt;/h1&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;查看读写速度
        iostat -d -x -k 1 5

        Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await  svctm  %util
        xvdb              0.00    23.00    0.00   47.00     0.00   280.00    11.91     0.54   11.55   0.49   2.30
        xvda              0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00
        xvdc              0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00
        xvdd              0.00     2.00    0.00  388.00     0.00  1560.00     8.04     1.26    3.26   0.34  13.10

        rrqm/s 每秒读请求合并的次数
        wrqm/s 每秒写请求合并的次数
        r/s 每秒读请求次数，这个值通常会跟avgrq-sz一起观察，avgrq-sz大则有可能r/s比较小
        w/s 每秒写请求次数，这个值通常会跟avgrq-sz一起观察，avgrq-sz大则有可能w/s比较小
        rkB/s 这个指标跟vmstat的bi值通常应该是很接近的
        wkB/s 这个指标跟vmstat的bo值通常应该是很接近的
        avgrq-sz 每个请求平均大小，单位是扇区数，一般在200~400之间算是正常和理想的状态，如果这个值比较小，比方说只在100左右，说明太多的IO请求没有被合并，或者大的IO请求被“打散”，在写操作时，过多小的请求会造成磁盘磁头的频繁移动，降低IO性能。
        avgqu-sz 平均请求队列长度，这个值在正常的系统中不应超过113太多，如果在200左右，甚至上千那说明发生了IO拥塞，而系统还在向IO请求队列中放请求（有一个例外是在执行sync,fsync操作时，该值到达最大值8192是正常的）
        await 单位是毫秒，不应超过两位数，几百甚至上千都是不可接受的。
        svctm 平均每次设备I/O操作的服务时间(毫秒)。即delta(use)/delta(rio+wio)
        %util 尽可能的让该值达到100%，否则说明IO能力没有完全被利用。

        如果svctm比较接近await,说明I/O几乎没有等待时间;
        如果await远大于svctm,说明I/O队列太长，应用得到的响应时间变慢。


磁盘平均队列长度 avgqu-sz 大于 3 就需要关注，
        iostat -xt 1


查看磁盘统计信息
        cat /proc/diskstats

     主设备号 次 设备名称   第1个域
     202      32 xvdc  			4959692 347 411803562 33790444 8109304 76242434 674813944 1340903295 0 14873863 1374687623
     202      33 xvdc1 			4959649 347 411803218 33790119 8109304 76242434 674813944 1340903295 0 14873753 1374687299
     202      48 xvdd  			222375610 17443 16714996538 923047010 5307720710 1063308104 50968261080 2447567938 0 1816063211 3368385818
     202      49 xvdd1 			222375567 17443 16714996194 923046942 5307720710 1063308104 50968261080 2447567938 0 1816063228 3368386366


    第1个域：读完成次数 ----- 读磁盘的次数，成功完成读的总次数。
    （number of issued reads. This is the total number of reads completed successfully.）

    第2个域：合并读完成次数， 第6个域：合并写完成次数。为了效率可能会合并相邻的读和写。从而两次4K的读在它最终被处理到磁盘上之前可能会变成一次8K的读，才被计数（和排队），因此只有一次I/O操作。这个域使你知道这样的操作有多频繁。
    （number of reads merged）

    第3个域：读扇区的次数，成功读过的扇区总次数。
    （number of sectors read. This is the total number of sectors read successfully.）

    第4个域：读花费的毫秒数，这是所有读操作所花费的毫秒数（用__make_request()到end_that_request_last()测量）。
    （number of milliseconds spent reading. This is the total number of milliseconds spent by all reads (as measured from __make_request() to end_that_request_last()).）

    第5个域：写完成次数 ----写完成的次数，成功写完成的总次数。
    （number of writes completed. This is the total number of writes completed successfully.）

    第6个域：合并写完成次数 -----合并写次数。
    （number of writes merged Reads and writes which are adjacent to each other may be merged for efficiency. Thus two 4K reads may become one 8K read before it is ultimately handed to the disk, and so it will be counted (and queued) as only one I/O. This field lets you know how often this was done.）

    第7个域：写扇区次数 ---- 写扇区的次数，成功写扇区总次数。
    （number of sectors written. This is the total number of sectors written successfully.）

    第8个域：写操作花费的毫秒数  ---  写花费的毫秒数，这是所有写操作所花费的毫秒数（用__make_request()到end_that_request_last()测量）。
    （number of milliseconds spent writing This is the total number of milliseconds spent by all writes (as measured from __make_request() to end_that_request_last()).）

    第9个域：正在处理的输入/输出请求数 -- -I/O的当前进度，只有这个域应该是0。当请求被交给适当的request_queue_t时增加和请求完成时减小。
    （number of I/Os currently in progress. The only field that should go to zero. Incremented as requests are given to appropriate request_queue_t and decremented as they finish.）

    第10个域：输入/输出操作花费的毫秒数  ----花在I/O操作上的毫秒数，这个域会增长只要field 9不为0。
    （number of milliseconds spent doing I/Os. This field is increased so long as field 9 is nonzero.）

    第11个域：输入/输出操作花费的加权毫秒数 -----  加权， 花在I/O操作上的毫秒数，在每次I/O开始，I/O结束，I/O合并时这个域都会增加。这可以给I/O完成时间和存储那些可以累积的提供一个便利的测量标准。
    （number of milliseconds spent doing I/Os. This field is incremented at each I/O start, I/O completion, I/O merge, or read of these stats by the number of I/Os in progress (field 9) times the number of milliseconds spent doing I/O since the last update of this field. This can provide an easy measure of both I/O completion time and the backlog that may be accumulating.）
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;以上操作经过验证可以直接拿去。&lt;/li&gt;
  &lt;li&gt;auther &lt;code class=&quot;highlighter-rouge&quot;&gt;breakEval13&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;https://github.com/breakEval13&lt;/li&gt;
&lt;/ul&gt;</content><author><name>breakeval13</name></author><summary type="html">Linux 操作系统日常巡检</summary></entry></feed>