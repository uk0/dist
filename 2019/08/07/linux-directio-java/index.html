<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Java实现DirectIo文件方式操作文件系统 &mdash; 下水鱼</title>
      <!-- or -->

    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="https://firsh.me/2019/08/07/linux-directio-java/">
    <link rel="alternate" type="application/atom+xml" title="下水鱼" href="/feed.xml">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <meta property="og:title" content="Java实现DirectIo文件方式操作文件系统">
      
    <meta name="keywords" content="directio java">
    <meta name="og:keywords" content="directio java">
      
    <meta name="description" content="场景  APIServer接口要求较高的并发，而且还要将数据文件存储到本地备份，在低消耗内存CPU情况下提高程序的运行速度以及稳定性。  相关文章 http://man7.org/linux/man-pages/man2/open.2.html  实现思路 调用Linux本身的接口 Java采用JNA实现">
    <meta name="og:description" content="场景  APIServer接口要求较高的并发，而且还要将数据文件存储到本地备份，在低消耗内存CPU情况下提高程序的运行速度以及稳定性。  相关文章 http://man7.org/linux/man-pages/man2/open.2.html  实现思路 调用Linux本身的接口 Java采用JNA实现">
      
    
    
        
    
    <meta property="og:url" content="https://firsh.me/2019/08/07/linux-directio-java/">
    <meta property="og:site_name" content="下水鱼">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2019-08-07">
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-3969253077255521",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
            src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    <script src="http://112firshme11224.test.upcdn.net/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://112firshme11224.test.upcdn.net/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="/" title="下水鱼"><span class="octicon octicon-mark-github"></span> 下水鱼</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a>
                
                <a href="/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="Java实现DirectIo文">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">Java实现DirectIo文件方式操作文件系统</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2019/08/07
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#Java" title="Java">Java</a>
          </span>
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#Linux" title="Linux">Linux</a>
          </span>
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="/categories/#Directio" title="Directio">Directio</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <h2 id="场景">场景</h2>
<ul>
  <li>APIServer接口要求较高的并发，而且还要将数据文件存储到本地备份，在低消耗内存CPU情况下提高程序的运行速度以及稳定性。</li>
  <li>相关文章 <code class="language-plaintext highlighter-rouge">http://man7.org/linux/man-pages/man2/open.2.html</code></li>
  <li>实现思路 调用Linux本身的接口 Java采用JNA实现</li>
</ul>

<h3 id="具体方法调用">具体方法调用</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">open</span><span class="o">(</span><span class="nc">String</span> <span class="n">pathname</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">fcntl</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">fd</span><span class="o">,</span> <span class="nc">Pointer</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">posix_memalign</span><span class="o">(</span><span class="nc">PointerByReference</span> <span class="n">memptr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">alignment</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">close</span><span class="o">(</span><span class="kt">int</span> <span class="n">fd</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="核心代码">核心代码</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 *    Copyright 2013 Matteo Catena (catena.matteo@gmail.com)
      Release v1 Owner  zhangjianxinnet@gmail.com 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
 */</span>
<span class="kn">package</span> <span class="nn">com.huadi.utils.directio.io</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.jna.Native</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jna.Pointer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jna.ptr.PointerByReference</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JNAOutputStream</span> <span class="kd">extends</span> <span class="nc">OutputStream</span> <span class="o">{</span>

	<span class="c1">//just a couple of them are used, here for eventual future uses</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_RDONLY</span> <span class="o">=</span> <span class="mo">00</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_WRONLY</span> <span class="o">=</span> <span class="mo">01</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_RDWR</span> <span class="o">=</span> <span class="mo">02</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_CREAT</span> <span class="o">=</span> <span class="mo">0100</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_EXCL</span> <span class="o">=</span> <span class="mo">0200</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_NOCTTY</span> <span class="o">=</span> <span class="mo">0400</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_TRUNC</span> <span class="o">=</span> <span class="mo">01000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_APPEND</span> <span class="o">=</span> <span class="mo">02000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_NONBLOCK</span> <span class="o">=</span> <span class="mo">04000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_NDELAY</span> <span class="o">=</span> <span class="no">O_NONBLOCK</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_SYNC</span> <span class="o">=</span> <span class="mo">010000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_ASYNC</span> <span class="o">=</span> <span class="mo">020000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_DIRECT</span> <span class="o">=</span> <span class="mo">040000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_DIRECTORY</span> <span class="o">=</span> <span class="mo">0200000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_NOFOLLOW</span> <span class="o">=</span> <span class="mo">0400000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_NOATIME</span> <span class="o">=</span> <span class="mo">01000000</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">O_CLOEXEC</span> <span class="o">=</span> <span class="mo">02000000</span><span class="o">;</span>
	
	<span class="c1">//fcntl has also other flags, not presented here</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">F_SETFL</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
	   	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">512</span><span class="o">;</span>    
  
	<span class="kd">static</span> <span class="o">{</span>
		<span class="nc">Native</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
	<span class="o">}</span>    
  
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">open</span><span class="o">(</span><span class="nc">String</span> <span class="n">pathname</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">fcntl</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">fd</span><span class="o">,</span> <span class="nc">Pointer</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">posix_memalign</span><span class="o">(</span><span class="nc">PointerByReference</span> <span class="n">memptr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">alignment</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">);</span>
	<span class="kd">private</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">close</span><span class="o">(</span><span class="kt">int</span> <span class="n">fd</span><span class="o">);</span>
  
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">fd</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">Pointer</span> <span class="n">bufPnt</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">pos</span><span class="o">;</span>
  
	<span class="kd">public</span> <span class="nf">JNAOutputStream</span><span class="o">(</span><span class="nc">String</span> <span class="n">pathname</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">direct</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  			
		<span class="k">if</span> <span class="o">(!</span><span class="n">direct</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="o">(</span><span class="n">pathname</span><span class="o">,</span> <span class="no">O_CREAT</span><span class="o">|</span><span class="no">O_TRUNC</span><span class="o">|</span><span class="no">O_WRONLY</span><span class="o">,</span> <span class="mo">00755</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="c1">//			fd = open(pathname, O_CREAT|O_TRUNC|O_WRONLY|O_DIRECT, 00755);</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="o">(</span><span class="n">pathname</span><span class="o">,</span> <span class="no">O_CREAT</span><span class="o">|</span><span class="no">O_APPEND</span><span class="o">|</span><span class="no">O_WRONLY</span><span class="o">|</span><span class="no">O_DIRECT</span><span class="o">,</span> <span class="mo">00755</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nc">PointerByReference</span> <span class="n">pntByRef</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PointerByReference</span><span class="o">();</span>
		<span class="n">posix_memalign</span><span class="o">(</span><span class="n">pntByRef</span><span class="o">,</span> <span class="no">BLOCK_SIZE</span><span class="o">,</span> <span class="no">BLOCK_SIZE</span><span class="o">);</span>
		<span class="n">bufPnt</span> <span class="o">=</span> <span class="n">pntByRef</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>    	
		<span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="no">BLOCK_SIZE</span><span class="o">];</span>
	<span class="o">}</span>
			
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		
		<span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">%</span> <span class="no">BLOCK_SIZE</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">fcntl</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="no">F_SETFL</span><span class="o">,</span> <span class="o">~</span><span class="no">O_DIRECT</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Impossible to modify fd on close()"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">bufPnt</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">pos</span><span class="o">);</span>
			<span class="kt">int</span> <span class="n">rtn</span> <span class="o">=</span> <span class="n">write</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span><span class="n">bufPnt</span><span class="o">,</span><span class="n">pos</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">rtn</span> <span class="o">!=</span> <span class="n">pos</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="n">rtn</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="n">pos</span><span class="o">+</span><span class="s">" bytes written to disk on close()"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">close</span><span class="o">(</span><span class="n">fd</span><span class="o">)&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Problems occured while doing close()"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>	
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="no">BLOCK_SIZE</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">buffer</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span><span class="n">b</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">==</span> <span class="no">BLOCK_SIZE</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">bufPnt</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="no">BLOCK_SIZE</span><span class="o">);</span>
			<span class="kt">int</span> <span class="n">rtn</span> <span class="o">=</span> <span class="n">write</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="n">bufPnt</span><span class="o">,</span> <span class="no">BLOCK_SIZE</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">rtn</span> <span class="o">!=</span> <span class="no">BLOCK_SIZE</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="n">rtn</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="no">BLOCK_SIZE</span><span class="o">+</span><span class="s">" bytes written to disk"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<h3 id="使用方式">使用方式</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 *    Copyright 2013 Matteo Catena (catena.matteo@gmail.com)

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
 */</span>
<span class="kn">package</span> <span class="nn">com.huadi.utils.directio.io</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Run</span> <span class="o">{</span>

	<span class="cm">/**
	 * @ower 张建新
	 * @param args
	 * @throws IOException 
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">());</span>
		<span class="kt">int</span> <span class="n">runs</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
		<span class="kt">int</span> <span class="n">integers</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
		<span class="kt">long</span><span class="o">[]</span> <span class="n">sio</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
		<span class="kt">long</span><span class="o">[]</span> <span class="n">jnaio</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
		<span class="kt">long</span><span class="o">[]</span> <span class="n">djnaio</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
		<span class="kt">int</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">integers</span><span class="o">];</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">integers</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">runs</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">runStd</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">sio</span><span class="o">);</span>
			<span class="n">runJNA</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">jnaio</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="n">runJNA</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">djnaio</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"JNA I/O (ns): "</span><span class="o">+</span><span class="n">jnaio</span><span class="o">[</span><span class="mi">1</span><span class="o">]/(</span><span class="kt">double</span><span class="o">)</span><span class="n">runs</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="n">jnaio</span><span class="o">[</span><span class="mi">0</span><span class="o">]/(</span><span class="kt">double</span><span class="o">)</span><span class="n">runs</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"O_DIRECT JNA I/O (ns): "</span><span class="o">+</span><span class="n">djnaio</span><span class="o">[</span><span class="mi">1</span><span class="o">]/(</span><span class="kt">double</span><span class="o">)</span><span class="n">runs</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="n">djnaio</span><span class="o">[</span><span class="mi">0</span><span class="o">]/(</span><span class="kt">double</span><span class="o">)</span><span class="n">runs</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Standard I/O (ns): "</span><span class="o">+</span><span class="n">sio</span><span class="o">[</span><span class="mi">1</span><span class="o">]/(</span><span class="kt">double</span><span class="o">)</span><span class="n">runs</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="n">sio</span><span class="o">[</span><span class="mi">0</span><span class="o">]/(</span><span class="kt">double</span><span class="o">)</span><span class="n">runs</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeLineToFile2</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span><span class="nc">String</span> <span class="n">filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">JNAOutputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
		<span class="n">write</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
		<span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runStd</span><span class="o">(</span><span class="kt">int</span> <span class="n">data</span><span class="o">[],</span> <span class="kt">long</span> <span class="n">time</span><span class="o">[])</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">"/tmp/"</span><span class="o">+</span><span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()+</span><span class="s">".bin"</span><span class="o">;</span>
		<span class="nc">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">),</span> <span class="mi">512</span><span class="o">));</span>
		<span class="n">time</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+=</span> <span class="n">write</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>	
		<span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="nc">DataInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">),</span> <span class="mi">512</span><span class="o">));</span>
		<span class="n">time</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+=</span> <span class="n">read</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
		<span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runJNA</span><span class="o">(</span><span class="kt">int</span> <span class="n">data</span><span class="o">[],</span> <span class="kt">long</span> <span class="n">time</span><span class="o">[],</span> <span class="kt">boolean</span> <span class="n">o_direct</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">"/tmp/"</span><span class="o">+</span><span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()+</span><span class="s">".bin"</span><span class="o">;</span>
		<span class="nc">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">JNAOutputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="n">o_direct</span><span class="o">));</span>
		<span class="n">time</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+=</span> <span class="n">write</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>	
		<span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="nc">DataInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">JNAInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="n">o_direct</span><span class="o">));</span>
		<span class="n">time</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+=</span> <span class="n">read</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
		<span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>	
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">write</span><span class="o">(</span><span class="nc">DataOutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
			<span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
		<span class="o">}</span>
		<span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
		<span class="k">return</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">write</span><span class="o">(</span><span class="nc">DataOutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
			<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
		<span class="o">}</span>
		<span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
		<span class="k">return</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
	<span class="o">}</span>


	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">read</span><span class="o">(</span><span class="nc">DataInputStream</span> <span class="n">in</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"wrong!"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>转载请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权</p>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      
  
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>
        var gitalk = new Gitalk({
            id: '/2019/08/07/linux-directio-java/',
            clientID: '0dc80b46a482ec78f3e0',
            clientSecret: '8cae5d306b3703ad240b74142995473086fcbbab',
            repo: 'blog-comments',
            owner: 'uk0',
            admin: ['uk0'],
            labels: ['gitment'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
      <!-- 多说公共JS代码 END -->
      <!-- Duoshuo Comment END -->
  


    </div>
  </div>
  <div class="column one-fourth">
    <h3>Affiliate</h3>
<a href="https://www.vultr.com/?ref=7142633"><img src="https://www.vultr.com/media/banner_3.png" width="300" height="250"></a>

<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
    <button class="btn btn-default" id="site_search_do"><span class="octicon octicon-search"></span></button>
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://112firshme11224.test.upcdn.net/assets/css/modules/sidebar-search.css">
<script src="http://112firshme11224.test.upcdn.net/assets/js/lunr.min.js"></script>
<script src="http://112firshme11224.test.upcdn.net/assets/js/search.js"></script>


    
<h3>Post Directory</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>
<script src="http://112firshme11224.test.upcdn.net/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="ZhangJianXin">ZhangJianXin</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/uk0/uk0.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="/wiki/" title="维基" target="">维基</a>
                </li>
                
                <li>
                    <a href="/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="http://112firshme11224.test.upcdn.net/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://112firshme11224.test.upcdn.net/assets/js/geopattern.js"></script>
    <script src="http://112firshme11224.test.upcdn.net/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://112firshme11224.test.upcdn.net/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
    <div style="display:none">
      <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-130872028-1"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-130872028-1');
        </script>
    </div>
    
</body>
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</html>
